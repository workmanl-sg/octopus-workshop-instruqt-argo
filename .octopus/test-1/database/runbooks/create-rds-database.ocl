name = "Create RDS Database"
default_guided_failure_mode = "EnvironmentDefault"
description = ""

connectivity_policy {
    allow_deployments_to_no_targets = true
}

run_retention_policy {
    quantity_to_keep = 100
}

process {
    step "apply-a-terraform-template" {
        name = "Apply a Terraform template"

        action {
            action_type = "Octopus.TerraformApply"
            properties = {
                Octopus.Action.Aws.Region = "eu-west-2"
                Octopus.Action.AwsAccount.UseInstanceRole = "False"
                Octopus.Action.AwsAccount.Variable = "AWS.Account"
                Octopus.Action.GitRepository.Source = "Project"
                Octopus.Action.GoogleCloud.ImpersonateServiceAccount = "False"
                Octopus.Action.GoogleCloud.UseVMServiceAccount = "True"
                Octopus.Action.Script.ScriptSource = "GitRepository"
                Octopus.Action.Terraform.AllowPluginDownloads = "True"
                Octopus.Action.Terraform.AzureAccount = "False"
                Octopus.Action.Terraform.GoogleCloudAccount = "False"
                Octopus.Action.Terraform.ManagedAccount = "AWS"
                Octopus.Action.Terraform.PlanJsonOutput = "False"
                Octopus.Action.Terraform.RunAutomaticFileSubstitution = "True"
                Octopus.Action.Terraform.TemplateDirectory = "IaC/RDS"
                OctopusUseBundledTooling = "False"
            }
            worker_pool = "hosted-ubuntu"

            container {
                feed = "docker-hub"
                image = "octopusdeploy/worker-tools:6.5.0-ubuntu.22.04"
            }
        }
    }

    step "print-terraform-outputs" {
        name = "Print Terraform Outputs "

        action {
            action_type = "Octopus.Script"
            properties = {
                Octopus.Action.Script.ScriptBody = <<-EOT
                    # Retrieve Terraform outputs from previous step
                    $instanceId = $OctopusParameters["Octopus.Action[Apply a Terraform template].Output.TerraformValueOutputs[instance_identifier]"]
                    $password   = $OctopusParameters["Octopus.Action[Apply a Terraform template].Output.TerraformValueOutputs[password]"]
                    $host       = $OctopusParameters["Octopus.Action[Apply a Terraform template].Output.TerraformValueOutputs[rds_host]"]
                    $port       = $OctopusParameters["Octopus.Action[Apply a Terraform template].Output.TerraformValueOutputs[rds_port]"]
                    $username   = $OctopusParameters["Octopus.Action[Apply a Terraform template].Output.TerraformValueOutputs[username]"]
                    
                    Write-Highlight "=== RDS SQL Server Deployment Output ==="
                    
                    Write-Highlight "Instance Identifier: $instanceId"
                    Write-Highlight "Host:               $host"
                    Write-Highlight "Port:               $port"
                    Write-Highlight "Username:           $username"
                    Write-Highlight "Password:           $password"
                    
                    Write-Highlight "========================================"
                    
                    EOT
                Octopus.Action.Script.ScriptSource = "Inline"
                Octopus.Action.Script.Syntax = "PowerShell"
                OctopusUseBundledTooling = "False"
            }
            worker_pool = "hosted-ubuntu"

            container {
                feed = "docker-hub"
                image = "octopusdeploy/worker-tools:6.5.0-ubuntu.22.04"
            }
        }
    }
}